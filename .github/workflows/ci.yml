name: Cbeci API production server deploy
on: 
  push:
    branches:
      - master
jobs:
  deploy:
    environment:
      name: TEST_ENV
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: CLI commands for deploy
      uses: appleboy/ssh-action@master
      env:
        SHA: ${{ github.sha }}
      with:
        host: ${{ secrets.PRODUCTION_SERVER_HOST }}
        username: cbeci
        port: 22
        envs: SHA
        script_stop: true
        key:  ${{ secrets.CBECI_USER_KEY }}
        script: |
          touch /home/cbeci/test_html/hello.txt
          echo "Hello world" > /home/cbeci/test_html/hello.txt
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@master
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true
    - name: Set outputs
      id: vars
      run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"
    - name: Use gcloud CLI
      run: |
        echo "SHORT SHA: "
        echo ${{ steps.vars.outputs.sha_short }}
